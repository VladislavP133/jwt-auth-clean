<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç ‚Äì –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–æ–±—Ä–∞–∂–µ–Ω—å</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    img {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
    }
    .history-img {
      max-height: 100px;
      margin-top: 5px;
    }
  </style>
</head>
<body class="container py-4">
  <h2 class="mb-4">üë§ –û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç</h2>

  <form id="generateForm" class="mb-4">
    <label for="prompt" class="form-label">–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–∏–π –æ–ø–∏—Å:</label>
    <input type="text" id="prompt" class="form-control mb-2" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –∫—ñ—Ç —É —Å–∫–∞—Ñ–∞–Ω–¥—Ä—ñ –Ω–∞ –ú—ñ—Å—è—Ü—ñ" required>
    <button class="btn btn-primary" type="submit">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</button>
  </form>

  <div id="imageResult" class="mb-4">
    
  </div>

  <hr>

  <h4>üïì –Ü—Å—Ç–æ—Ä—ñ—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ–π</h4>
  <ul id="historyList" class="list-group mt-2">
    
  </ul>

  <button class="btn btn-danger mt-4" onclick="logout()">–í–∏–π—Ç–∏</button>

  <script>
    const form = document.getElementById('generateForm');
    const imageResult = document.getElementById('imageResult');
    const historyList = document.getElementById('historyList');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = document.getElementById('prompt').value;

      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ prompt })
      });

      const data = await res.json();

      if (res.ok && data.imageUrl) {
        imageResult.innerHTML = `
          <h5 class="mt-3">üé® –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:</h5>
          <img src="${data.imageUrl}" alt="AI Image">
        `;
        document.getElementById('prompt').value = '';
        loadHistory(); 
      } else {
        imageResult.innerHTML = `<p class="text-danger">–ü–æ–º–∏–ª–∫–∞: ${data.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è'}</p>`;
      }
    });

    async function loadHistory() {
      const res = await fetch('/api/generate/history', { credentials: 'include' });
      const data = await res.json();

      if (res.ok && Array.isArray(data)) {
        historyList.innerHTML = '';
        data.reverse().forEach(entry => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.innerHTML = `
            <strong>${entry.prompt}</strong><br>
            <img class="history-img" src="${entry.imageUrl}" alt="">
          `;
          historyList.appendChild(li);
        });
      }
    }

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      window.location.href = '/login.html';
    }

    loadHistory();
  </script>
</body>
</html>
